'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},axios=require('axios');try{var fs=require('fs')}catch(a){fs={}}module.exports=function(a){var b=_extends({filePath:'public/',fileName:'cache.js',strict:!1,onUpdated:function a(){return null}},a);b.api=_extends({method:'patch',route:'/api/update/',validIP:null},a.api);var c=b.list,d=b.api;('/'!==d.route.slice(-1)||'/'!==d.route.slice(0,1))&&console.error('ERROR ssr-api-cache: add slash character at start and end of "api.route" property in setup config.(exp: "/api/update/")'),'/'!==b.filePath.slice(-1)&&console.error('ERROR ssr-api-cache: add slash character at end of "filePath" property in setup config.'),'undefined'==typeof c&&console.error('ERROR ssr-api-cache: please set "list" property in setup config, because this is a require parameter.');var e=function(){var a='window.__ssrApiCache__='+JSON.stringify(global.__ssrApiCache__),c=b.filePath+b.fileName,d=new Promise(function(b,d){fs.writeFile(c,a,function(a){a?(console.error(a),d('occur an error during write on clientside js file.')):b('succesfully write fileContext inside of clientside js file.')})});return d},f=function(a,c){var d=global.__ssrApiCache__[a.name];'undefined'!=typeof a&&(global.__ssrApiCache__[a.name]=c);var f=e();return f.then(function(){b.onUpdated(a,c)}).catch(function(){global.__ssrApiCache__[a.name]=d}),f},g=function(a){var b=new Promise(function(b,c){axios({url:a.url}).then(function(d){f(a,d.data).then(function(a){b(a)}).catch(function(a){c(a)})}).catch(function(b){b.response?(console.log(b.response.data),console.log(b.response.status),console.log(b.response.headers)):b.request?console.log(b.request):console.log(b.message),c('can not fetch data from '+a.url+' API.')})});return b};if(global.__ssrApiCache__={},c.forEach(function(a){global.__ssrApiCache__[a.name]=a.default||null}),e().then(function(){console.info('SUCCESSFULL ssr-api-cache: cache items defined with default value successfully.'),c.forEach(function(a){g(a).catch(function(a){console.error('ERROR ssr-api-cache: ',a,'(error in first load)')})})}),'undefined'!=typeof d.express){var h=d.route+':name';d.express.use(h,function(a,b,e){if(a.method.toLowerCase()===d.method.toLowerCase()){var f=d.validIP,h=a.params.name,i=a.headers['x-forwarded-for']||a.connection.remoteAddress,j=!1;if(Array.isArray(f)){var k=f.filter(function(a){return a===i});j=0===k.length}else'string'==typeof f&&(j=i!==f);if(j)return b.status(402).send('You have not access to run update cache api!'),!1;var l=null;c.forEach(function(a){a.name===h&&(l=a)}),null===l?b.status(404).send('not found any item with name = '+h+'. check inserted value.'):g(l).then(function(){b.status(200).send(h+' successfully updated.')}).catch(function(a){console.error('ERROR ssr-api-cache: ',a,'(error in update API - requested IP '+i+')'),b.status(500).send('have error during fetch data from api \''+l.api+'\' of \''+l.name+'\'.')})}else e()})}};