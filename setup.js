'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},axios=require('axios');try{var fs=require('fs')}catch(a){fs={}}module.exports=function(a){var b=_extends({filePath:'public/',fileName:'cache.js',strict:!1,onUpdated:function a(){return null}},a);b.api=_extends({method:'patch',route:'/api/update/',validIP:null},a.api);var c=b.list,d=b.api;('/'!==d.route.slice(-1)||'/'!==d.route.slice(0,1))&&console.error('ERROR ssr-api-cache: add slash character at start and end of "api.route" property in setup config.(exp: "/api/update/")'),'/'!==b.filePath.slice(-1)&&console.error('ERROR ssr-api-cache: add slash character at end of "filePath" property in setup config.'),'undefined'==typeof c&&console.error('ERROR ssr-api-cache: please set "list" property in setup config, because this is a require parameter.');var e=function(){var a='window.__ssrApiCache__='+JSON.stringify(global.__ssrApiCache__),c=b.filePath+b.fileName,d=new Promise(function(b,d){fs.writeFile(c,a,function(a){a?(console.error(a),d('occur an error during write on clientside js file.')):b('succesfully write fileContext inside of clientside js file.')})});return d},f=function(a,c){var d=global.__ssrApiCache__[a.name];'undefined'!=typeof a&&(global.__ssrApiCache__[a.name]=c);var f=e();return f.then(function(){b.onUpdated(a,c)}).catch(function(){global.__ssrApiCache__[a.name]=d}),f},g=function(a){var b=new Promise(function(b,c){axios({url:a.url}).then(function(d){f(a,d.data).then(function(a){b(a)}).catch(function(a){c(a)})}).catch(function(b){b.response?(console.log(b.response.data),console.log(b.response.status),console.log(b.response.headers)):b.request?console.log(b.request):console.log(b.message),c('can not fetch data from '+a.url+' API.')})});return b};if(global.__ssrApiCache__={},c.forEach(function(a){global.__ssrApiCache__[a.name]=a.default||null}),e().then(function(){console.info('SUCCESSFULL ssr-api-cache: cache items defined with default value successfully.'),c.forEach(function(a){g(a).catch(function(a){console.error('ERROR ssr-api-cache: ',a,'(error in first load)')})})}),'undefined'!=typeof d.express){var h=d.route+':name';d.express.use(h,function(a,e,f){if(a.method===d.method.toLowerCase()){var h=b.app.validIP,i=a.params.name,j=a.headers['x-forwarded-for']||a.connection.remoteAddress,k=void 0,l=void 0,m=!1;if(Array.isArray(h)){var n=h.filter(function(a){return a===j});m=0===n.length}else'string'==typeof h&&(m=j!==h);m&&(k=402,l='You have not access to run update cache api!');var o=null;c.forEach(function(a){a.name===i&&(o=a)}),null===o?(k=404,l='not found any item with name = '+i+'. check inserted value.'):g(o).then(function(){k=200,l=i+' successfully updated.'}).catch(function(a){console.error('ERROR ssr-api-cache: ',a,'(error in update API - requested IP '+j+')'),k=500,l='have error during fetch data from api \''+o.api+'\' of \''+o.name+'\'.'}),e.status(k).send(l)}else f()})}};